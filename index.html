<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zonas Seguras - Mapa Interactivo v3</title> <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @font-face {
        font-family: 'LucideIcons';
        src: url(https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf) format('truetype');
      }
      .lucide {
        font-family: 'LucideIcons';
        font-size: 1.25rem;
        line-height: 1;
      }
      /* Base styles remain the same */
      #map { height: calc(100vh - 100px); width: 100%; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      .leaflet-popup-content-wrapper { border-radius: 0.5rem; }
      .leaflet-popup-content { margin: 1rem; max-height: 350px; overflow-y: auto; } /* Increased max-height */
      .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; color: white; font-weight: bold; z-index: 10000; display: none; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.3s ease-in-out; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
      .toast.show { display: block; opacity: 1; transform: translateX(-50%) translateY(0); }
      .toast.safe { background-color: #28a745; }
      .toast.caution { background-color: #ffc107; color: #333; }
      .toast.warning-low { background-color: #fd7e14; }
      .toast.warning-medium { background-color: #dc3545; }
      .toast.warning-high { background-color: #800080; }
      button, .radio-button-label { transition: all 0.3s ease; }
      button:hover, .radio-button-label:hover { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
      button:active, .radio-button-label:active { transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
      #add-zone-modal { transition: opacity 0.3s ease-in-out; }
      #add-zone-modal.hidden { opacity: 0; }
      #add-zone-modal:not(.hidden) { opacity: 1; }
      .comment { background-color: #f3f4f6; padding: 6px 10px; border-radius: 6px; margin-bottom: 4px; font-size: 0.8rem; border: 1px solid #e5e7eb; }
      .radio-button-group input[type="radio"] { opacity: 0; position: fixed; width: 0; }
      .radio-button-label { display: inline-block; background-color: #e5e7eb; padding: 8px 12px; font-family: sans-serif, Arial; font-size: 14px; border: 2px solid #d1d5db; border-radius: 6px; cursor: pointer; margin-right: 5px; margin-bottom: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
      .radio-button-group input[type="radio"]:checked + label { background-color: #bfdbfe; border-color: #3b82f6; color: #1e40af; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
      .radio-button-label.safe { border-left: 5px solid #10B981; }
      .radio-button-label.caution { border-left: 5px solid #F59E0B; }
      .radio-button-label.danger-low { border-left: 5px solid #F97316; }
      .radio-button-label.danger-medium { border-left: 5px solid #EF4444; }
      .radio-button-label.danger-high { border-left: 5px solid #8B5CF6; }
      #bottom-legend { position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); z-index: 1000; background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(4px); padding: 0.5rem 1rem; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); display: flex; gap: 1rem; align-items: center; justify-content: center; }
      .legend-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
      .legend-icon { width: 2rem; height: 2rem; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); margin-bottom: 0.25rem; }
      .legend-icon svg { width: 100%; height: 100%; }
      .legend-label { font-size: 0.7rem; font-weight: 600; color: #4b5563; line-height: 1; }
      /* Styles for Edit/Delete buttons in popup */
      .zone-actions { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around; gap: 0.5rem; }
      .zone-actions button { font-size: 0.7rem; padding: 4px 8px; }

    </style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'safe-zone': '#10B981', 'caution-zone': '#F59E0B', 'danger-low': '#F97316',
                        'danger-medium': '#EF4444', 'danger-high': '#8B5CF6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans flex flex-col h-screen">

    <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Zonas Seguras v3</h1> <div class="flex space-x-2">
             <button id="add-zone-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center space-x-2">
                <span class="lucide">&#xea15;</span> <span>Añadir Zona</span>
            </button>
             <button id="locate-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center space-x-2">
                <span class="lucide">&#xe9fa;</span> <span>Mi Ubicación</span>
            </button>
             <button id="toggle-layer-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center space-x-2">
                <span class="lucide">&#xea6f;</span> <span>Satélite</span>
            </button>
        </div>
    </header>

    <main class="flex-grow relative p-4">
        <div id="map"></div>

        <div id="bottom-legend">
            <div class="legend-item" aria-label="Nivel Muy Segura"><div class="legend-icon bg-safe-zone"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="p-1"><path d="M20 6L9 17l-5-5"/></svg></div><span class="legend-label">SEGURA</span></div>
            <div class="legend-item" aria-label="Nivel Precaución"><div class="legend-icon bg-caution-zone"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" class="p-1.5"><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14v-2h-2v2h2zm0-4h-2v-4h2v4z"/></svg></div><span class="legend-label">PRECAUCIÓN</span></div>
            <div class="legend-item" aria-label="Nivel Peligro Leve"><div class="legend-icon bg-danger-low"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="p-1.5"><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14v-2h-2v2h2zm0-4h-2v-4h2v4z"/></svg></div><span class="legend-label">LEVE</span></div>
            <div class="legend-item" aria-label="Nivel Peligro Moderado"><div class="legend-icon bg-danger-medium"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="p-1.5"><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14v-2h-2v2h2zm0-4h-2v-4h2v4z"/></svg></div><span class="legend-label">MODERADO</span></div>
            <div class="legend-item" aria-label="Nivel Peligro Alto"><div class="legend-icon bg-danger-high"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="p-1.5"><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14v-2h-2v2h2zm0-4h-2v-4h2v4z"/></svg></div><span class="legend-label">ALTO</span></div>
        </div>

        <div id="toast-notification" class="toast"><span id="toast-message"></span></div>

         <div id="add-zone-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[5000] hidden items-center justify-center">
             <div class="relative mx-auto p-6 border w-full max-w-md shadow-lg rounded-lg bg-white">
                 <h3 class="text-lg font-semibold text-gray-900 mb-4">Añadir Nueva Zona Segura</h3>
                 <form id="add-zone-form">
                     <div class="mb-4"><label for="zone-description" class="block text-sm font-medium text-gray-700 mb-1">Descripción:</label><input type="text" id="zone-description" name="description" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ej: Zona turística segura" required></div>
                     <div class="mb-4"><label for="zone-radius" class="block text-sm font-medium text-gray-700 mb-1">Radio (50-100 metros):</label><input type="range" id="zone-radius" name="radius" min="50" max="100" value="75" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"><span id="radius-value" class="text-sm text-gray-600">75 metros</span></div>
                     <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Nivel de Peligro Inicial:</label><div class="radio-button-group flex flex-wrap"><input type="radio" id="score--2" name="initialScore" value="-2"><label for="score--2" class="radio-button-label safe">Muy Segura (-2)</label><input type="radio" id="score--1" name="initialScore" value="-1"><label for="score--1" class="radio-button-label safe">Segura (-1)</label><input type="radio" id="score-0" name="initialScore" value="0" checked><label for="score-0" class="radio-button-label caution">Neutra (0)</label><input type="radio" id="score-1" name="initialScore" value="1"><label for="score-1" class="radio-button-label danger-low">Leve (1)</label><input type="radio" id="score-3" name="initialScore" value="3"><label for="score-3" class="radio-button-label danger-medium">Moderado (3)</label><input type="radio" id="score-6" name="initialScore" value="6"><label for="score-6" class="radio-button-label danger-high">Alto (6)</label></div></div>
                     <div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-add-zone" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow">Cancelar</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow">Guardar Zona</button></div>
                 </form>
             </div>
         </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- Initial Setup ---
        const mapElement = document.getElementById('map');
        const locateButton = document.getElementById('locate-btn');
        const toggleLayerButton = document.getElementById('toggle-layer-btn');
        const addZoneButton = document.getElementById('add-zone-btn');
        const addZoneModal = document.getElementById('add-zone-modal');
        const cancelAddZoneButton = document.getElementById('cancel-add-zone');
        const addZoneForm = document.getElementById('add-zone-form');
        const radiusSlider = document.getElementById('zone-radius');
        const radiusValueSpan = document.getElementById('radius-value');
        const toastElement = document.getElementById('toast-notification');
        const toastMessageElement = document.getElementById('toast-message');

        let map;
        let currentBaseLayer = 'street';
        let streetLayer, satelliteLayer;
        let userMarker = null;
        let locationWatcher = null;
        // Updated zone structure: {id, lat, lng, radius, score, initialScore, description, comments: [], creatorId, layer}
        let zones = [];
        let zoneIdCounter = 0;
        let addingZoneMode = false;
        let tempMarker = null; // Marker for adding a new zone
        let moveMarker = null; // Marker specifically for moving an existing zone
        let movingZoneId = null; // ID of the zone currently being moved

        const ZONES_STORAGE_KEY = 'safeZonesData_v3'; // Updated key for new structure
        const USER_ID_KEY = 'safeZonesUserId'; // Key for simulated user ID

        // --- User ID Simulation ---
        function getCurrentUserId() {
            let userId = localStorage.getItem(USER_ID_KEY);
            if (!userId) {
                // Generate a simple pseudo-random ID if none exists
                userId = 'user_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem(USER_ID_KEY, userId);
            }
            return userId;
        }
        const currentUserId = getCurrentUserId(); // Get user ID once on load

        // --- Utility Functions ---
        function getColorForScore(score) { /* ... (no changes) ... */ if (score < 0) return '#10B981'; if (score === 0) return '#F59E0B'; if (score >= 1 && score <= 2) return '#F97316'; if (score >= 3 && score <= 5) return '#EF4444'; return '#8B5CF6'; }
        function getSafetyLevelDescription(score) { /* ... (no changes) ... */ if (score <= -2) return 'Muy Segura'; if (score === -1) return 'Segura'; if (score === 0) return 'Precaución'; if (score >= 1 && score <= 2) return 'Peligro Leve'; if (score >= 3 && score <= 5) return 'Peligro Moderado'; return 'Peligro Alto'; }
        function showToast(message, level) { /* ... (no changes) ... */ toastMessageElement.textContent = message; toastElement.className = 'toast show'; switch (level) { case 'safe': toastElement.classList.add('safe'); break; case 'caution': toastElement.classList.add('caution'); break; case 'warning-low': toastElement.classList.add('warning-low'); break; case 'warning-medium': toastElement.classList.add('warning-medium'); break; case 'warning-high': toastElement.classList.add('warning-high'); break; default: toastElement.classList.add('bg-gray-700'); } setTimeout(() => { toastElement.classList.remove('show'); toastElement.style.transform = 'translateX(-50%) translateY(-100px)'; setTimeout(() => { toastElement.style.transform = 'translateX(-50%)'; }, 50); }, 5000); }
        function escapeHtml(unsafe) { /* ... (no changes) ... */ if (!unsafe) return ''; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        // --- Map Initialization ---
        function initializeMap() {
            map = L.map(mapElement, { zoomControl: false }).setView([40.7128, -74.0060], 13);
            L.control.zoom({ position: 'topright' }).addTo(map);
            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles &copy; Esri' });
            loadZonesFromStorage();
            renderZones();
            map.on('click', handleMapClick);
            map.on('locationfound', onLocationFound);
            map.on('locationerror', onLocationError);
            startWatchingLocation();
            console.log("Current User ID (Simulated):", currentUserId); // Log simulated user ID
        }

        // --- Zone Management ---
        function loadZonesFromStorage() {
            const storedZones = localStorage.getItem(ZONES_STORAGE_KEY);
            if (storedZones) {
                try {
                    zones = JSON.parse(storedZones);
                    zoneIdCounter = zones.reduce((maxId, zone) => Math.max(maxId, zone.id), -1) + 1;
                    // --- Compatibility: Add missing fields for older data ---
                    zones.forEach(zone => {
                        if (zone.initialScore === undefined) {
                            zone.initialScore = zone.score; // Assume initial score was the current score
                        }
                        if (!zone.creatorId) {
                            zone.creatorId = null; // Mark as unknown creator (or assign currentUserId for demo)
                            // zone.creatorId = currentUserId; // Alternative for testing: assign old zones to current user
                        }
                        if (!zone.comments) {
                            zone.comments = [];
                        }
                    });
                    // --- End Compatibility ---
                    console.log("Zonas cargadas desde localStorage (v3).");
                } catch (e) {
                    console.error("Error al parsear zonas (v3):", e);
                    zones = []; zoneIdCounter = 0; loadSampleZones(); // Fallback to samples
                }
            } else {
                console.log("No hay zonas v3. Cargando ejemplos.");
                loadSampleZones(); saveZonesToStorage();
            }
        }

        function saveZonesToStorage() {
            try {
                const zonesToSave = zones.map(({ layer, ...rest }) => rest); // Exclude Leaflet layer
                localStorage.setItem(ZONES_STORAGE_KEY, JSON.stringify(zonesToSave));
            } catch (e) {
                console.error("Error al guardar zonas v3:", e);
                showToast("Error al guardar datos.", "warning-medium");
            }
        }

        function loadSampleZones() {
            // Add creatorId and initialScore to sample zones
            zones = [
                { id: 0, lat: 40.7150, lng: -74.0080, radius: 80, score: -2, initialScore: -2, description: "Parque tranquilo", comments: ["Muy agradable."], creatorId: 'user_sample_1' },
                { id: 1, lat: 40.7100, lng: -74.0050, radius: 60, score: 4, initialScore: 3, description: "Callejón oscuro", comments: ["Evitar noche."], creatorId: 'user_sample_2' }, // Score changed from initial
                { id: 2, lat: 40.7180, lng: -74.0020, radius: 100, score: 1, initialScore: 1, description: "Zona concurrida", comments: [], creatorId: currentUserId }, // Assign one to current user for testing
                { id: 3, lat: 40.7120, lng: -74.0110, radius: 50, score: 6, initialScore: 6, description: "Actividad sospechosa", comments: [], creatorId: 'user_sample_3' },
                { id: 4, lat: 40.7080, lng: -74.0000, radius: 70, score: 0, initialScore: 0, description: "Plaza central", comments: [], creatorId: currentUserId } // Assign another for testing
            ];
            zoneIdCounter = 5;
        }

        function renderZones() {
            zones.forEach(zone => { if (zone.layer && map.hasLayer(zone.layer)) map.removeLayer(zone.layer); });
            zones.forEach(zone => {
                const color = getColorForScore(zone.score);
                zone.layer = L.circle([zone.lat, zone.lng], { color: color, fillColor: color, fillOpacity: 0.4, radius: zone.radius }).addTo(map);
                zone.layer.bindPopup(createPopupContent(zone), { minWidth: 250, maxHeight: 350 }); // Adjusted maxHeight
                zone.layer.zoneData = zone;
            });
        }

        function createPopupContent(zone) {
            const safetyLevel = getSafetyLevelDescription(zone.score);
            const scoreColor = getColorForScore(zone.score);
            let colorClass = '';
            if (scoreColor === '#10B981') colorClass = 'text-safe-zone'; else if (scoreColor === '#F59E0B') colorClass = 'text-caution-zone'; else if (scoreColor === '#F97316') colorClass = 'text-danger-low'; else if (scoreColor === '#EF4444') colorClass = 'text-danger-medium'; else if (scoreColor === '#8B5CF6') colorClass = 'text-danger-high';

            let commentsHtml = '<p class="text-xs text-gray-500 mt-3 mb-1">Comentarios:</p>';
            if (zone.comments && zone.comments.length > 0) { commentsHtml += zone.comments.map(comment => `<div class="comment">${escapeHtml(comment)}</div>`).join(''); }
            else { commentsHtml += '<p class="text-xs text-gray-400 italic">No hay comentarios.</p>'; }

            const commentFormHtml = `<div class="mt-3 pt-3 border-t"><textarea id="comment-input-${zone.id}" class="w-full p-1 border rounded text-xs" rows="2" placeholder="Añade comentario..."></textarea><button class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold py-1 px-2 rounded mt-1" onclick="addCommentToZone(${zone.id})">Enviar</button></div>`;

            // --- Creator Actions ---
            let creatorActionsHtml = '';
            // IMPORTANT: Check against the globally defined currentUserId
            if (zone.creatorId === currentUserId) {
                creatorActionsHtml += '<div class="zone-actions">';
                // Delete Button (only if score hasn't changed)
                if (zone.score === zone.initialScore) {
                    creatorActionsHtml += `<button class="bg-red-600 hover:bg-red-700 text-white rounded shadow" onclick="deleteZone(${zone.id})">Eliminar Zona</button>`;
                } else {
                     // Optional: Show disabled button or message if score changed
                     creatorActionsHtml += `<button class="bg-red-300 text-white rounded cursor-not-allowed" title="No se puede eliminar, ya tiene votos" disabled>Eliminar Zona</button>`;
                }
                // Move Button
                creatorActionsHtml += `<button class="bg-yellow-500 hover:bg-yellow-600 text-white rounded shadow" onclick="startMovingZone(${zone.id})">Mover Zona</button>`;
                creatorActionsHtml += '</div>';
            }
            // --- End Creator Actions ---

            return `<div class="text-sm space-y-2"><p class="font-semibold text-base text-gray-800">${escapeHtml(zone.description) || 'Zona sin descripción'}</p><p><span class="font-semibold">Nivel:</span> <span class="font-bold ${colorClass}">${safetyLevel}</span> (Puntuación: ${zone.score})</p><p><span class="font-semibold">Radio:</span> ${zone.radius} metros</p><hr class="my-2"><p class="text-xs text-gray-600 mb-1">¿Cómo percibes esta zona?</p><div class="flex justify-center space-x-3"><button class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full shadow transition transform hover:scale-105" onclick="voteZone(${zone.id}, 1)">+1 Peligro</button><button class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-full shadow transition transform hover:scale-105" onclick="voteZone(${zone.id}, -1)">-1 Segura</button></div>${creatorActionsHtml}${commentsHtml}${commentFormHtml}</div>`;
        }

        function handleMapClick(e) {
            // Prevent adding zone if move is in progress
            if (movingZoneId !== null) {
                showToast("Termina o cancela mover la zona actual antes de añadir una nueva.", "caution");
                return;
            }
            if (addingZoneMode) {
                const { lat, lng } = e.latlng;
                if (tempMarker) { tempMarker.setLatLng(e.latlng); }
                else { tempMarker = L.marker(e.latlng, { draggable: true }).addTo(map).bindPopup("Arrastra para ajustar. Completa el formulario.").openPopup(); }
                addZoneModal.classList.remove('hidden'); addZoneModal.classList.add('flex');
                radiusSlider.value = 75; radiusValueSpan.textContent = `75 metros`;
                document.getElementById('zone-description').focus();
                document.getElementById('score-0').checked = true;
            }
        }

        function startAddingZone() {
             // Prevent adding zone if move is in progress
             if (movingZoneId !== null) {
                showToast("Termina o cancela mover la zona actual.", "caution");
                return;
            }
            addingZoneMode = true; showToast("Haz clic en el mapa para marcar el centro.", "info");
            mapElement.style.cursor = 'crosshair'; map.closePopup();
            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
        }

        function cancelAddingZone() {
            addingZoneMode = false; addZoneModal.classList.add('hidden'); addZoneModal.classList.remove('flex');
            mapElement.style.cursor = ''; if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
            addZoneForm.reset(); radiusValueSpan.textContent = '75 metros';
            document.getElementById('score-0').checked = true;
        }

        function saveNewZone(event) {
            event.preventDefault();
            if (!tempMarker) { showToast("Marca primero la ubicación en el mapa.", "caution"); return; }
            const latlng = tempMarker.getLatLng();
            const description = document.getElementById('zone-description').value;
            const radius = parseInt(document.getElementById('zone-radius').value, 10);
            const selectedScoreElement = document.querySelector('input[name="initialScore"]:checked');
            if (!selectedScoreElement) { showToast("Selecciona un nivel de peligro inicial.", "caution"); return; }
            const score = parseInt(selectedScoreElement.value, 10);
            const newZone = {
                id: zoneIdCounter++, lat: latlng.lat, lng: latlng.lng, radius: radius,
                score: score, initialScore: score, // Set both score and initialScore
                description: description, comments: [],
                creatorId: currentUserId, // Assign current user ID
                layer: null
            };
            zones.push(newZone); saveZonesToStorage(); renderZones(); cancelAddingZone();
            showToast("Nueva zona añadida correctamente.", "safe");
        }

        window.voteZone = function(zoneId, vote) {
            // Prevent voting while moving a zone
            if (movingZoneId !== null) {
                showToast("No se puede votar mientras se mueve una zona.", "caution");
                return;
            }
            const zone = zones.find(z => z.id === zoneId);
            if (zone) {
                zone.score += vote; saveZonesToStorage();
                const newColor = getColorForScore(zone.score);
                if (zone.layer && map.hasLayer(zone.layer)) {
                    zone.layer.setStyle({ color: newColor, fillColor: newColor });
                    if (zone.layer.isPopupOpen()) {
                        // Update popup content, potentially disabling delete button if score changed
                        zone.layer.setPopupContent(createPopupContent(zone));
                    }
                    zone.layer.bringToFront();
                    showToast(`Voto registrado. Nueva puntuación: ${zone.score}`, 'info');
                } else { console.warn("Voting on zone without layer:", zoneId); renderZones(); }
            }
        }

         window.addCommentToZone = function(zoneId) {
             // Prevent commenting while moving a zone
            if (movingZoneId !== null) {
                showToast("No se puede comentar mientras se mueve una zona.", "caution");
                return;
            }
            const commentInput = document.getElementById(`comment-input-${zoneId}`);
            const commentText = commentInput.value.trim();
            if (!commentText) { showToast("El comentario no puede estar vacío.", "caution"); return; }
            const zone = zones.find(z => z.id === zoneId);
            if (zone) {
                if (!zone.comments) zone.comments = [];
                zone.comments.push(commentText); saveZonesToStorage();
                if (zone.layer && map.hasLayer(zone.layer) && zone.layer.isPopupOpen()) { zone.layer.setPopupContent(createPopupContent(zone)); }
                 commentInput.value = ''; showToast("Comentario añadido.", "safe");
            }
         }

        // --- Delete Zone Functionality ---
        window.deleteZone = function(zoneId) {
            const zoneIndex = zones.findIndex(z => z.id === zoneId);
            if (zoneIndex === -1) return;
            const zone = zones[zoneIndex];

            // Double check conditions (creator and score hasn't changed)
            if (zone.creatorId !== currentUserId) {
                showToast("No puedes eliminar esta zona.", "warning-medium");
                return;
            }
            if (zone.score !== zone.initialScore) {
                 showToast("No se puede eliminar, la puntuación ha cambiado.", "warning-medium");
                 // Update popup to potentially hide the button again if state is inconsistent
                 if (zone.layer && map.hasLayer(zone.layer) && zone.layer.isPopupOpen()) {
                     zone.layer.setPopupContent(createPopupContent(zone));
                 }
                 return;
            }

            // Confirmation dialog
            if (confirm(`¿Estás seguro de que quieres eliminar esta zona?\n"${escapeHtml(zone.description) || 'Zona ' + zone.id}"`)) {
                // Remove layer from map
                if (zone.layer && map.hasLayer(zone.layer)) {
                    map.removeLayer(zone.layer);
                }
                // Remove zone from array
                zones.splice(zoneIndex, 1);
                // Save updated array to localStorage
                saveZonesToStorage();
                // Optional: Redraw all zones (simplest way to update map)
                // renderZones(); // Or just rely on the layer removal
                showToast("Zona eliminada correctamente.", "safe");
            }
        }

        // --- Move Zone Functionality ---
        window.startMovingZone = function(zoneId) {
             // Prevent starting a new move if one is already in progress
            if (movingZoneId !== null) {
                showToast("Ya estás moviendo otra zona.", "caution");
                return;
            }
             // Prevent moving if adding a zone
             if (addingZoneMode) {
                 showToast("Termina o cancela añadir la nueva zona primero.", "caution");
                 return;
             }

            const zone = zones.find(z => z.id === zoneId);
            if (!zone || zone.creatorId !== currentUserId) {
                showToast("No puedes mover esta zona.", "warning-medium");
                return;
            }

            movingZoneId = zoneId; // Set the global flag

            // Close the original zone's popup
            if (zone.layer && map.hasLayer(zone.layer)) {
                zone.layer.closePopup();
                // Optionally hide the original circle temporarily
                zone.layer.setStyle({ opacity: 0.1, fillOpacity: 0.05 });
            }

            // Create a temporary draggable marker at the current center
            moveMarker = L.marker([zone.lat, zone.lng], {
                draggable: true,
                icon: L.icon({ // Use a distinct icon for moving
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                })
            }).addTo(map);

            // Add popup to the move marker with confirm/cancel actions
            const movePopupContent = `
                <div class="text-center p-2 space-y-2">
                    <p class="text-sm font-semibold">Mover Zona</p>
                    <p class="text-xs">Arrastra el marcador a la nueva ubicación.</p>
                    <div class="flex justify-around gap-2 mt-2">
                        <button class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded" onclick="confirmMoveZone()">Confirmar</button>
                        <button class="bg-gray-400 hover:bg-gray-500 text-white text-xs font-bold py-1 px-3 rounded" onclick="cancelMoveZone()">Cancelar</button>
                    </div>
                </div>
            `;
            moveMarker.bindPopup(movePopupContent).openPopup();

            showToast("Arrastra el marcador azul para reubicar la zona.", "info");
        }

        window.confirmMoveZone = function() {
            if (movingZoneId === null || !moveMarker) return;

            const zone = zones.find(z => z.id === movingZoneId);
            if (!zone) {
                console.error("Zone to move not found:", movingZoneId);
                cancelMoveZone(); // Clean up if zone is missing
                return;
            }

            const newLatLng = moveMarker.getLatLng();

            // Update zone data
            zone.lat = newLatLng.lat;
            zone.lng = newLatLng.lng;
            zone.score = 0; // Reset score
            zone.initialScore = 0; // Reset initial score as well

            // Clean up move state
            map.removeLayer(moveMarker);
            moveMarker = null;
            const movedZoneId = movingZoneId; // Store before resetting
            movingZoneId = null;

            saveZonesToStorage(); // Save changes
            renderZones(); // Redraw all zones to reflect the move and score reset
            showToast("Zona movida y puntuación reiniciada a 0.", "safe");

             // Optional: Re-open popup of the moved zone after redraw
             setTimeout(() => {
                 const updatedZone = zones.find(z => z.id === movedZoneId);
                 if(updatedZone && updatedZone.layer) {
                     updatedZone.layer.openPopup();
                 }
             }, 100); // Short delay to allow redraw
        }

        window.cancelMoveZone = function() {
            if (movingZoneId === null) return; // Already cancelled or not moving

            const zone = zones.find(z => z.id === movingZoneId);

             // Restore original circle visibility if it was hidden
             if (zone && zone.layer && map.hasLayer(zone.layer)) {
                 zone.layer.setStyle({ opacity: 1, fillOpacity: 0.4 }); // Restore original opacity
             }

            // Clean up move state
            if (moveMarker) {
                map.removeLayer(moveMarker);
                moveMarker = null;
            }
            movingZoneId = null;

            showToast("Movimiento de zona cancelado.", "info");
        }


        // --- Map Control Functions ---
        function locateUserOnce() { map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: true }); }
        function startWatchingLocation() { /* ... (no changes) ... */ if (navigator.geolocation) { if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher); locationWatcher = navigator.geolocation.watchPosition(onLocationUpdate, onLocationError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); console.log("Iniciando seguimiento..."); } else { showToast("Geolocalización no soportada.", "warning-medium"); } }
        function onLocationUpdate(position) { /* ... (no changes) ... */ const latlng = L.latLng(position.coords.latitude, position.coords.longitude); const accuracy = position.coords.accuracy; console.log(`Ubicación: ${latlng}, Precisión: ${accuracy}m`); if (!userMarker) { userMarker = L.marker(latlng, { icon: L.divIcon({ className: 'user-location-marker', html: '<div class="w-3 h-3 bg-blue-500 rounded-full border-2 border-white shadow animate-pulse"></div>', iconSize: [12, 12], iconAnchor: [6, 6] }) }).addTo(map); userMarker.bindPopup(`Estás aquí (${accuracy.toFixed(0)} m)`).openPopup(); map.setView(latlng, 16); } else { userMarker.setLatLng(latlng); userMarker.setPopupContent(`Estás aquí (${accuracy.toFixed(0)} m)`); } checkProximity(latlng); }
        function onLocationFound(e) { /* ... (no changes) ... */ console.log("Ubicación (locate):", e.latlng); onLocationUpdate({ coords: { latitude: e.latlng.lat, longitude: e.latlng.lng, accuracy: e.accuracy } }); }
        function onLocationError(error) { /* ... (no changes) ... */ console.error("Error Geoloc:", error.message, `(Code: ${error.code})`); let message = "No se pudo obtener ubicación"; if (error.code === 1) message = "Permiso denegado."; else if (error.code === 2) message = "Ubicación no disponible."; else if (error.code === 3) message = "Tiempo agotado."; showToast(message, "warning-medium"); if (locationWatcher && (error.code === 1 || error.code === 2)) { navigator.geolocation.clearWatch(locationWatcher); locationWatcher = null; console.log("Seguimiento detenido."); } }
        function toggleBaseLayer() { /* ... (no changes) ... */ if (currentBaseLayer === 'street') { map.removeLayer(streetLayer); map.addLayer(satelliteLayer); currentBaseLayer = 'satellite'; toggleLayerButton.innerHTML = `<span class="lucide">&#xea9e;</span> <span>Calles</span>`; } else { map.removeLayer(satelliteLayer); map.addLayer(streetLayer); currentBaseLayer = 'street'; toggleLayerButton.innerHTML = `<span class="lucide">&#xea6f;</span> <span>Satélite</span>`; } }
        function checkProximity(userLatLng) { /* ... (no changes) ... */ let closestDangerousZone = null; let minDistance = Infinity; zones.forEach(zone => { if (zone.score >= 1) { const zoneLatLng = L.latLng(zone.lat, zone.lng); const distance = userLatLng.distanceTo(zoneLatLng); if (distance <= zone.radius) { if (!closestDangerousZone || zone.score > closestDangerousZone.score || (zone.score === closestDangerousZone.score && distance < minDistance)) { closestDangerousZone = zone; minDistance = distance; } } } }); if (closestDangerousZone) { const level = getSafetyLevelDescription(closestDangerousZone.score); let toastLevel = 'warning-low'; if (closestDangerousZone.score >= 3 && closestDangerousZone.score <= 5) toastLevel = 'warning-medium'; else if (closestDangerousZone.score > 5) toastLevel = 'warning-high'; showToast(`¡Atención! Estás en zona ${level}: ${escapeHtml(closestDangerousZone.description) || 'Zona ' + closestDangerousZone.id}`, toastLevel); } }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            locateButton.addEventListener('click', locateUserOnce);
            toggleLayerButton.addEventListener('click', toggleBaseLayer);
            addZoneButton.addEventListener('click', startAddingZone);
            cancelAddZoneButton.addEventListener('click', cancelAddingZone);
            addZoneForm.addEventListener('submit', saveNewZone);
            radiusSlider.addEventListener('input', (e) => { radiusValueSpan.textContent = `${e.target.value} metros`; });

             // Add listener to close move marker popup if user clicks elsewhere on map
             map.on('click', () => {
                if (movingZoneId !== null && moveMarker && !moveMarker.isPopupOpen()) {
                    // If move is active but popup closed (e.g., by clicking map), maybe cancel?
                    // Or just let it be, user needs to click marker again. For now, do nothing extra.
                }
             });

             // Prevent map click handling during move marker drag
             map.on('dragstart', () => {
                 if (movingZoneId !== null) {
                     // Temporarily disable map click handling? Not strictly necessary.
                 }
             });
        });
    </script>
</body>
</html>
